// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  id               String           @id @default(uuid())
  name             String
  email            String           @unique
  chatuserid       String?
  phoneNumber      String?
  companyName      String?
  profileUrl       String?
  role             Role             @default(candidate)
  password         String?
  emailverified    Boolean?
  isactive         Boolean?
  createdAt        DateTime         @default(now())
  CandidateProfile UserProfile?     @relation("CandidateUserProfile")
  VendorProfiles   UserProfile[]    @relation("VendorUserProfiles")
  address          Address?
  Job              Job[]            @relation("UserPostedJobs")
  JobApplications  JobApplication[] @relation("UserAsCandidate")
  AppliedJobs      JobApplication[] @relation("AppliedByUser")
  SavedJobs        SavedJob[]
  courses          Course[]
  reviews          Review[]
  dashboards       Dashboard[]

  recruiterActivities Activity[] @relation("RecruiterActivities")
  candidateActivities Activity[] @relation("CandidateActivities")
}

enum Role {
  candidate
  company
  admin
}

enum JobType {
  FullTime
  Contract
  Freelance
}

model UserProfile {
  id                           String    @id @default(uuid())
  userId                       String?   @unique
  vendorId                     String?
  chatuserid                   String?
  user                         Users?    @relation("CandidateUserProfile", fields: [userId], references: [id], onDelete: Cascade)
  vendor                       Users?    @relation("VendorUserProfiles", fields: [vendorId], references: [id], onDelete: Cascade)
  profilePicture               String?
  title                        String?
  name                         String?
  phoneNumber                  String?
  email                        String?
  portfolioLink                String?
  preferredLocation            String[]
  currentLocation              String?
  preferredJobType             JobType[]
  currentCTC                   String?
  expectedCTC                  String?
  rateCardPerHour              Json?
  status                       String?
  joiningPeriod                String?
  totalExperience              String?
  relevantSalesforceExperience String?

  skillsJson      Json? // e.g. [{ name: "Apex", experience: 3, level: "primary" }]
  primaryClouds   Json?
  secondaryClouds Json?

  certifications   String[]
  workExperience   Json?
  education        Json?
  isContactDetails Boolean?
  // address          Address?

  linkedInUrl  String?
  trailheadUrl String?

  isVerified      Boolean   @default(false)
  verificationOtp String?
  otpExpiry       DateTime?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  jobApplications JobApplication[]
}

model Skills {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Certification {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Location {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Cloud {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model CompanyRole {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Qualification {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

enum EmploymentType {
  FullTime
  PartTime
  Internship
  Contract
  Freelance
}

enum ExperienceLevel {
  Internship
  EntryLevel
  Mid
  Senior
  Lead
}

enum JobStatus {
  Open
  Closed
  Draft
}

model Job {
  id                  String           @id @default(uuid())
  role                String
  description         String
  employmentType      EmploymentType
  tenure              Json?
  experience          Json?
  experienceLevel     ExperienceLevel?
  location            String?
  skills              String[] // Array of Json Skills
  clouds              String[]
  salary              String
  companyName         String?
  responsibilities    String
  certifications      String[]
  jobType             String
  status              JobStatus        @default(Open)
  applicationDeadline String?
  isDeleted           Boolean          @default(false)
  deletedReason       String?
  deletedAt           DateTime?

  postedById String?
  postedBy   Users?  @relation("UserPostedJobs", fields: [postedById], references: [id])

  applications JobApplication[]
  savedBy      SavedJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ApplicationStatus {
  Pending
  Reviewed
  Shortlisted
  Rejected
  Hired
}

model JobApplication {
  id                 String  @id @default(uuid())
  jobId              String
  userId             String
  candidateProfileId String? // TEMP optional
  appliedById        String? // TEMP optional

  status    ApplicationStatus @default(Pending)
  appliedAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  job              Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user             Users        @relation("UserAsCandidate", fields: [userId], references: [id], onDelete: Cascade)
  appliedBy        Users?       @relation("AppliedByUser", fields: [appliedById], references: [id])
  candidateProfile UserProfile? @relation(fields: [candidateProfileId], references: [id])

  analysis ApplicationAnalysis?

  @@unique([jobId, candidateProfileId])
  @@index([userId])
  @@index([jobId])
  @@index([candidateProfileId])
  @@index([appliedById])
}

model ApplicationAnalysis {
  id               String @id @default(uuid())
  jobApplicationId String @unique // 1:1 Relation

  // Extracted Score for fast sorting (0 to 100)
  fitPercentage Int @default(0)

  // The detailed AI response
  // Stores: key_gaps, key_matches, scoring_breakdown, etc.
  details Json

  // Track status in case AI fails or is processing
  status AnalysisStatus @default(COMPLETED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobApplication JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)

  @@index([fitPercentage]) // Critical for sorting candidates by rank
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model SavedJob {
  id      String   @id @default(uuid())
  jobId   String
  userId  String
  savedAt DateTime @default(now())

  job  Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId]) // Prevent duplicate saves
  @@index([userId])
  @@index([jobId])
}

model Address {
  id         String  @id @default(uuid())
  doorNumber String?
  street     String?
  city       String?
  state      String?
  country    String?
  pinCode    String?
  userId     String  @unique
  user       Users   @relation(fields: [userId], references: [id])
}

model Country {
  id     String  @id @default(uuid())
  name   String  @unique
  code   String?
  states State[]
}

model State {
  id        String  @id @default(uuid())
  name      String
  code      String?
  countryId String
  country   Country @relation(fields: [countryId], references: [id])
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Float    @default(0)
  currency    String?
  createdAt   DateTime @default(now())
  userId      String
  courseType  String?
  instructor  Users    @relation(fields: [userId], references: [id])
  classes     Class[] // renamed relation
  url         String?
  reviews     Review[]

  @@index([userId])
}

model Class {
  id          String   @id @default(uuid())
  fileName    String
  url         String // Multer uploaded file URL
  type        String // "video", "pdf", "image"
  title       String // Class title
  description String? // Optional class description
  size        Int? // File size in bytes
  duration    Int? // Video duration in seconds
  metaData    Json? // Optional additional metadata
  createdAt   DateTime @default(now())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id])

  @@index([courseId])
}

model Review {
  id      String @id @default(uuid())
  rating  Float
  comment String

  userId   String
  courseId String

  user   Users  @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId]) // prevents duplicate review by same user
  @@index([courseId])
  @@index([userId])
}

enum DatasetType {
  JOBS
  APPLICATIONS
  APPLICATION_ANALYSIS
}

enum ChartType {
  LINE
  COLUMN
  BAR
  PIE
  DONUT
  SCATTER
  AREA
  MULTI_LINE
  STACK_AREA
  STACKED_COLUMN
  GROUPED_COLUMN
  GROUP_AND_STACK_COLUMN
  NUMBER_CARD
}

enum MetricType {
  COUNT
  AVG
  MIN
  MAX
}

model Dashboard {
  id          String            @id @default(uuid())
  name        String
  description String?
  ownerId     String
  owner       Users             @relation(fields: [ownerId], references: [id])
  widgets     DashboardWidget[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([ownerId])
}

model DashboardWidget {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])

  title         String
  dataset       DatasetType
  chartType     ChartType
  metricType    MetricType
  metricField   String? // e.g. "fitPercentage" for AVG
  xField        String? // e.g. "status", "createdAt"
  categoryField String? // e.g. "status" or "employmentType" for color/category split
  timeBucket    String? // "day" | "week" | "month"

  filters Json? // [{ field, operator, value }]
  sort    Json? // { field, direction }
  display Json? // UI-only settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dashboardId])
}

enum ActivityCategory {
  NOTE
  SCHEDULE
}

enum NoteType {
  CALL
  EMAIL
  MESSAGE
}

enum ScheduleType {
  INTERVIEW
  MEETING
  FOLLOW_UP
}

model Activity {
  id String @id @default(uuid())

  recruiterId String
  candidateId String

  category ActivityCategory

  recruiter Users @relation("RecruiterActivities", fields: [recruiterId], references: [id], onDelete: Cascade)
  candidate Users @relation("CandidateActivities", fields: [candidateId], references: [id], onDelete: Cascade)

  note     ActivityNote?
  schedule ActivitySchedule?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recruiterId])
  @@index([candidateId])
  @@index([category])
}

model ActivityNote {
  id String @id @default(uuid())

  activityId String   @unique
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  subject      String
  noteType     NoteType
  description  String?
  interactedAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivitySchedule {
  id String @id @default(uuid())

  activityId String   @unique
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  title        String
  scheduleType ScheduleType
  startTime    DateTime
  endTime      DateTime
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
