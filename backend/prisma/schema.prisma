// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üë• Members & Access
  members OrganizationMember[]
  invites OrganizationInvite[]

  // üî• NEW BILLING SYSTEM
  subscription  OrganizationSubscription?
  aiTokenUsages AITokenUsage[]

  // üíº Hiring & Jobs
  jobs            Job[]
  jobApplications JobApplication[]
  savedJobs       SavedJob[]
  savedCandidates SavedCandidate[]

  // üë§ Candidates
  userProfile UserProfile[]

  // üìù Activities & Tasks
  activities        Activity[]
  taskTemplates     TaskTemplate[]
  candidateTaskList CandidateTaskList[]
  candidateTasks    CandidateTask[]
}

model OrganizationMember {
  id             String        @id @default(uuid())
  organizationId String
  userId         String        @unique
  role           OrgMemberRole @default(COMPANY_USER)
  permissions    OrgPermission @default(FULL_ACCESS)

  user         Users        @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  license      License?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

enum OrgMemberRole {
  COMPANY_ADMIN
  COMPANY_USER
}

enum OrgPermission {
  VIEW_ONLY
  VIEW_EDIT
  FULL_ACCESS
}

model OrganizationInvite {
  id             String        @id @default(uuid())
  email          String
  token          String        @unique
  organizationId String
  role           OrgMemberRole @default(COMPANY_USER)
  permissions    OrgPermission @default(VIEW_ONLY)

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([email])
}

model Users {
  id               String           @id @default(uuid())
  name             String
  email            String           @unique
  chatuserid       String?
  phoneNumber      String?
  companyName      String?
  profileUrl       String?
  role             Role             @default(candidate)
  password         String?
  emailverified    Boolean?
  // refreshToken     String?
  isactive         Boolean?
  createdAt        DateTime         @default(now())
  // plan             Plan             @default(FREE)
  // aiUsedCount      Int              @default(0)
  // aiResetAt        DateTime?
  CandidateProfile UserProfile?     @relation("CandidateUserProfile")
  VendorProfiles   UserProfile[]    @relation("VendorUserProfiles")
  savedCandidates  SavedCandidate[] @relation("RecruiterSavedCandidates")
  address          Address?
  Job              Job[]            @relation("UserPostedJobs")
  JobApplications  JobApplication[] @relation("UserAsCandidate")
  AppliedJobs      JobApplication[] @relation("AppliedByUser")
  SavedJobs        SavedJob[]
  courses          Course[]
  reviews          Review[]
  dashboards       Dashboard[]

  recruiterActivities Activity[]          @relation("RecruiterActivities")
  candidateRatings    CandidateRating[]
  organizationMember  OrganizationMember?
  userSession         UserSession[]
  taskTemplate        TaskTemplate[]
  candidateTaskList   CandidateTaskList[]
  aiTokenUsages       AITokenUsage[]
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  revoked      Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  candidate
  company
  admin
}

enum JobType {
  FullTime
  Contract
  Freelance
}

model UserProfile {
  id                           String            @id @default(uuid())
  userId                       String?           @unique
  vendorId                     String?
  chatuserid                   String?
  user                         Users?            @relation("CandidateUserProfile", fields: [userId], references: [id], onDelete: Cascade)
  vendor                       Users?            @relation("VendorUserProfiles", fields: [vendorId], references: [id], onDelete: Cascade)
  savedByRecruiters            SavedCandidate[]  @relation("CandidateSavedByRecruiters")
  profilePicture               String?
  title                        String?
  summary                      String            @default("")
  CandidateRating              CandidateRating[]
  name                         String?
  phoneNumber                  String?
  email                        String?
  portfolioLink                String?
  preferredLocation            String[]
  currentLocation              String?
  preferredJobType             JobType[]
  currentCTC                   String?
  expectedCTC                  String?
  rateCardPerHour              Json?
  status                       String?
  joiningPeriod                String?
  totalExperience              String?
  relevantSalesforceExperience String?

  skillsJson      Json? // e.g. [{ name: "Apex", experience: 3, level: "primary" }]
  primaryClouds   Json?
  secondaryClouds Json?

  certifications   String[]
  workExperience   Json?
  education        Json?
  isContactDetails Boolean?
  // address          Address?

  linkedInUrl  String?
  trailheadUrl String?

  isVerified      Boolean   @default(false)
  verificationOtp String?
  otpExpiry       DateTime?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  jobApplications     JobApplication[]
  organizationId      String?
  organization        Organization?       @relation(fields: [organizationId], references: [id])
  candidateActivities Activity[]          @relation("CandidateActivities")
  candidateTaskList   CandidateTaskList[]
}

model Skills {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Certification {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Location {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Cloud {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model CompanyRole {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

model Qualification {
  id         String  @id @default(uuid())
  name       String  @unique
  isVerified Boolean @default(false)
}

enum EmploymentType {
  FullTime
  PartTime
  Internship
  Contract
  Freelance
}

enum ExperienceLevel {
  Internship
  EntryLevel
  Mid
  Senior
  Lead
}

enum JobStatus {
  Open
  Closed
  Draft
}

model Job {
  id                  String           @id @default(uuid())
  role                String
  description         String
  employmentType      EmploymentType
  tenure              Json?
  experience          Json?
  experienceLevel     ExperienceLevel?
  location            String?
  skills              String[] // Array of Json Skills
  clouds              String[]
  salary              String
  companyName         String?
  responsibilities    String
  certifications      String[]
  jobType             String
  status              JobStatus        @default(Open)
  applicationDeadline String?
  isDeleted           Boolean          @default(false)
  deletedReason       String?
  deletedAt           DateTime?
  ApplicationLimit    Int?
  companyLogo         String?

  postedById String?
  postedBy   Users?  @relation("UserPostedJobs", fields: [postedById], references: [id])

  applications JobApplication[]
  savedBy      SavedJob[]

  organizationId    String?
  organization      Organization?       @relation(fields: [organizationId], references: [id])
  activity          Activity[]
  candidateTaskList CandidateTaskList[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

enum ApplicationStatus {
  Pending
  Reviewed
  Shortlisted
  Rejected
  Hired
  Clear
  BookMark
}

model JobApplication {
  id                 String  @id @default(uuid())
  jobId              String
  userId             String
  candidateProfileId String? // TEMP optional
  appliedById        String? // TEMP optional

  status    ApplicationStatus @default(Pending)
  appliedAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  job              Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user             Users        @relation("UserAsCandidate", fields: [userId], references: [id], onDelete: Cascade)
  appliedBy        Users?       @relation("AppliedByUser", fields: [appliedById], references: [id])
  candidateProfile UserProfile? @relation(fields: [candidateProfileId], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  analysis ApplicationAnalysis?

  @@unique([jobId, candidateProfileId])
  @@index([userId])
  @@index([jobId])
  @@index([candidateProfileId])
  @@index([appliedById])
}

model ApplicationAnalysis {
  id               String @id @default(uuid())
  jobApplicationId String @unique // 1:1 Relation

  // Extracted Score for fast sorting (0 to 100)
  fitPercentage Int @default(0)

  // The detailed AI response
  // Stores: key_gaps, key_matches, scoring_breakdown, etc.
  details Json

  // Track status in case AI fails or is processing
  status AnalysisStatus @default(COMPLETED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobApplication JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)

  @@index([fitPercentage]) // Critical for sorting candidates by rank
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model SavedJob {
  id      String   @id @default(uuid())
  jobId   String
  userId  String
  savedAt DateTime @default(now())

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  job  Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId]) // Prevent duplicate saves
  @@unique([jobId, organizationId])
  @@index([userId])
  @@index([jobId])
}

model Address {
  id         String  @id @default(uuid())
  doorNumber String?
  street     String?
  city       String?
  state      String?
  country    String?
  pinCode    String?
  userId     String  @unique
  user       Users   @relation(fields: [userId], references: [id])
}

model Country {
  id     String  @id @default(uuid())
  name   String  @unique
  code   String?
  states State[]
}

model State {
  id        String  @id @default(uuid())
  name      String
  code      String?
  countryId String
  country   Country @relation(fields: [countryId], references: [id])
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Float    @default(0)
  currency    String?
  createdAt   DateTime @default(now())
  userId      String
  courseType  String?
  instructor  Users    @relation(fields: [userId], references: [id])
  classes     Class[] // renamed relation
  url         String?
  reviews     Review[]

  @@index([userId])
}

model Class {
  id          String   @id @default(uuid())
  fileName    String
  url         String // Multer uploaded file URL
  type        String // "video", "pdf", "image"
  title       String // Class title
  description String? // Optional class description
  size        Int? // File size in bytes
  duration    Int? // Video duration in seconds
  metaData    Json? // Optional additional metadata
  createdAt   DateTime @default(now())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id])

  @@index([courseId])
}

model Review {
  id      String @id @default(uuid())
  rating  Float
  comment String

  userId   String
  courseId String

  user   Users  @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId]) // prevents duplicate review by same user
  @@index([courseId])
  @@index([userId])
}

enum DatasetType {
  JOBS
  APPLICATIONS
  APPLICATION_ANALYSIS
}

enum ChartType {
  LINE
  COLUMN
  BAR
  PIE
  DONUT
  SCATTER
  AREA
  MULTI_LINE
  STACK_AREA
  STACKED_COLUMN
  GROUPED_COLUMN
  GROUP_AND_STACK_COLUMN
  NUMBER_CARD
}

enum MetricType {
  COUNT
  AVG
  MIN
  MAX
}

model Dashboard {
  id          String            @id @default(uuid())
  name        String
  description String?
  ownerId     String
  owner       Users             @relation(fields: [ownerId], references: [id])
  widgets     DashboardWidget[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([ownerId])
}

model DashboardWidget {
  id          String    @id @default(uuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])

  title         String
  dataset       DatasetType
  chartType     ChartType
  metricType    MetricType
  metricField   String? // e.g. "fitPercentage" for AVG
  xField        String? // e.g. "status", "createdAt"
  categoryField String? // e.g. "status" or "employmentType" for color/category split
  timeBucket    String? // "day" | "week" | "month"

  filters Json? // [{ field, operator, value }]
  sort    Json? // { field, direction }
  display Json? // UI-only settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dashboardId])
}

enum ActivityCategory {
  NOTE
  SCHEDULE
  WHATSAPP
}

enum NoteType {
  CALL
  EMAIL
  MESSAGE
}

enum ScheduleType {
  INTERVIEW
  MEETING
  FOLLOW_UP
}

model Activity {
  id String @id @default(uuid())

  recruiterId String
  candidateId String
  jobId       String

  category ActivityCategory

  recruiter Users       @relation("RecruiterActivities", fields: [recruiterId], references: [id], onDelete: Cascade)
  candidate UserProfile @relation("CandidateActivities", fields: [candidateId], references: [id], onDelete: Cascade)

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  note     ActivityNote?
  schedule ActivitySchedule?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recruiterId])
  @@index([candidateId])
  @@index([category])
}

model ActivityNote {
  id String @id @default(uuid())

  activityId String   @unique
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  subject      String
  noteType     NoteType
  description  String?
  interactedAt DateTime
  startTime    DateTime?
  endTime      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivitySchedule {
  id String @id @default(uuid())

  activityId String   @unique
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  title        String
  scheduleType ScheduleType
  startTime    DateTime
  endTime      DateTime
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SavedCandidate {
  id String @id @default(uuid())

  recruiterId        String // company / recruiter user
  candidateProfileId String

  // source             SavedCandidateSource @default(MANUAL)
  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recruiter        Users       @relation("RecruiterSavedCandidates", fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateProfile UserProfile @relation("CandidateSavedByRecruiters", fields: [candidateProfileId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@unique([recruiterId, candidateProfileId]) // prevent duplicate saves
  @@index([recruiterId])
  @@index([candidateProfileId])
}

model TaskTemplate {
  id             String @id @default(uuid())
  recruiterId    String
  organizationId String

  title     String
  order     Int
  isDefault Boolean  @default(false) // system provided
  isActive  Boolean  @default(true) // recruiter can disable without deleting
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recruiter    Users        @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([recruiterId])
  @@index([organizationId])
}

model CandidateTaskList {
  id             String   @id @default(uuid())
  recruiterId    String
  candidateId    String
  jobId          String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  recruiter    Users        @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidate    UserProfile  @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  tasks CandidateTask[]

  @@unique([recruiterId, candidateId, jobId, organizationId])
  @@index([candidateId])
  @@index([organizationId])
}

model CandidateTask {
  id             String @id @default(uuid())
  taskListId     String
  organizationId String

  title     String
  completed Boolean   @default(false)
  order     Int
  isActive  Boolean   @default(true)
  dueDate   DateTime?

  createdFromId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  taskList     CandidateTaskList @relation(fields: [taskListId], references: [id], onDelete: Cascade)
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([taskListId])
  @@index([organizationId])
}

model CandidateRating {
  id String @id @default(uuid())

  recruiterId        String
  candidateProfileId String

  rating  Int // 1 to 5 only
  comment String?

  recruiter        Users       @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateProfile UserProfile @relation(fields: [candidateProfileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([recruiterId, candidateProfileId])
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

model EmailLog {
  id      String      @id @default(uuid())
  to      String
  subject String?
  status  EmailStatus @default(PENDING)

  provider  String? // gmail, sendgrid, ses
  messageId String?
  response  String?
  error     String?

  retries   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

model OrganizationSubscription {
  id             String             @id @default(uuid())
  organizationId String             @unique
  status         SubscriptionStatus @default(ACTIVE)
  billingCycle   BillingCycle       @default(MONTHLY)
  autoRenew      Boolean            @default(true)

  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  licenses License[]
  invoices Invoice[]
  payments Payment[]
}

model License {
  id             String  @id @default(uuid())
  subscriptionId String
  planId         String
  assignedToId   String? @unique

  validFrom  DateTime @default(now())
  validUntil DateTime
  isActive   Boolean  @default(true)

  subscription OrganizationSubscription @relation(fields: [subscriptionId], references: [id])
  plan         SubscriptionPlan         @relation(fields: [planId], references: [id])
  assignedTo   OrganizationMember?      @relation(fields: [assignedToId], references: [id])

  usageRecords UsageRecord[]
  aiUsages     AITokenUsage[]
}

model SubscriptionPlan {
  id           String           @id @default(uuid())
  tier         SubscriptionTier @unique
  name         String
  monthlyPrice Int
  yearlyPrice  Int

  licenses License[]
  limits   PlanLimit[]
}

model PlanLimit {
  id      String       @id @default(uuid())
  planId  String
  feature LimitFeature
  period  LimitPeriod

  maxAllowed Int

  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, feature, period])
  @@index([planId])
}

model UsageRecord {
  id        String       @id @default(uuid())
  licenseId String
  feature   LimitFeature
  period    LimitPeriod

  currentUsage Int      @default(0)
  periodStart  DateTime
  periodEnd    DateTime
  isExceeded   Boolean  @default(false)

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, feature, period, periodStart])
  @@index([licenseId])
}

model AITokenUsage {
  id             String @id @default(uuid())
  organizationId String
  userId         String
  licenseId      String

  inputTokens  Int
  outputTokens Int
  totalTokens  Int
  featureUsed  String?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         Users        @relation(fields: [userId], references: [id])
  license      License      @relation(fields: [licenseId], references: [id])
}

model Invoice {
  id             String        @id @default(uuid())
  subscriptionId String
  invoiceNumber  String        @unique
  status         InvoiceStatus @default(PENDING)

  subtotal Int
  tax      Int
  total    Int

  periodStart DateTime
  periodEnd   DateTime
  dueDate     DateTime
  paidAt      DateTime?

  subscription OrganizationSubscription @relation(fields: [subscriptionId], references: [id])
  payments     Payment[]
}

model Payment {
  id             String @id @default(uuid())
  subscriptionId String
  invoiceId      String

  amount   Int
  currency String        @default("INR")
  status   PaymentStatus @default(PENDING)

  gateway          String
  gatewayPaymentId String?
  gatewaySessionId String?

  subscription OrganizationSubscription @relation(fields: [subscriptionId], references: [id])
  invoice      Invoice                  @relation(fields: [invoiceId], references: [id])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionTier {
  BASIC
  PROFESSIONAL
  ORGANIZATION
  ENTERPRISE
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  VOID
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum LimitFeature {
  AI_TOKENS_TOTAL
  FIT_SCORE_ANALYSES
  JOB_POST_CREATION
  ACTIVE_JOB_POSTINGS
  CANDIDATE_DETAILS_VIEW
  JOB_APPLICATIONS
  TEAM_MEMBERS
}

enum LimitPeriod {
  DAILY
  MONTHLY
  YEARLY
}
